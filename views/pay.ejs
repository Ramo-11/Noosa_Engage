<html>
    <head>
        <title>Payment</title>
        <link rel="stylesheet" href="/styles/general.css">
        <link rel="stylesheet" href="/styles/pay.css">
        <link rel="shortcut icon" href="/images/Logo-white.png">
        <script src="https://js.stripe.com/v3/"></script>
    </head>
    <body>
        <%- include("./partials/nav.ejs") %>
        <div class="main-content">
            <div class="title-div">
                <h1>Make a Payment</h1>
            </div>
            <form class="payment-form" id="payment-form">
                <div id="payment-element">
                    <!--Stripe.js injects the Payment Element-->
                </div>
                <button id="submit">
                    <div class="spinner hidden" id="spinner"></div>
                    <span id="button-text">Pay now</span>
                </button>
                <div id="payment-message" class="hidden"></div>
            </form>
        </div>
        <%- include("./partials/footer.ejs") %>

        <script>
            const stripe = Stripe("<%= stripePublicKey %>");
            let elements;

            document.addEventListener("DOMContentLoaded", async () => {
                const urlParams = new URLSearchParams(window.location.search)
                const invoiceNumber = urlParams.get('invoice');

                const response = await fetch("/api/payInvoice", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ invoiceNumber })
                })
                const data = await response.json()

                if (response.status !== 200) {
                    displayError(data.message)
                    return;
                }

                const appearance = { theme: 'stripe' };
                elements = stripe.elements({ appearance, clientSecret: data.clientSecret });
                const paymentElement = elements.create("payment", { layout: "tabs" });
                paymentElement.mount("#payment-element");
            });

            document.getElementById("payment-form").addEventListener("submit", async (event) => {
                event.preventDefault()
                disableSubmitButton()

                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: "http://localhost:3000/payment-success",  // Set your success URL here
                    }
                })

                if (error) {
                    displayError(error.message)
                    enableSubmitButton()
                } else {
                    displaySuccess("Payment successful!")
                }
            })

            // Helper functions to show error and success messages
            function displayError(message) {
                const messageDiv = document.getElementById("payment-message")
                messageDiv.classList.remove("hidden")
                messageDiv.innerText = "Error: " + message
            }

            function displaySuccess(message) {
                const messageDiv = document.getElementById("payment-message")
                messageDiv.classList.remove("hidden")
                messageDiv.innerText = message
            }

            function disableSubmitButton() {
                document.getElementById("submit").disabled = true
            }

            function enableSubmitButton() {
                document.getElementById("submit").disabled = false
            }

        </script>
    </body>
</html>
