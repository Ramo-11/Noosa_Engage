<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/general.css">
    <link rel="stylesheet" href="/styles/profile.css">
    <link rel="shortcut icon" href="/images/Logo-white.png">
    <title>User Profile</title>
</head>
<body>
    <%- include("../partials/nav.ejs") %>

    <div class="title-div">
        <h1>Your Account</h1>
    </div>

    <div class="profile-container">
        <div class="back-button-container">
            <a href="/dashboard" class="back-button">‚Üê</a>
        </div>
        <div class="profile-picture">
            <% if (user.profilePicture && user.profilePicture.data) { %>
                <img src="data:<%= user.profilePicture.contentType %>;base64,<%= user.profilePicture.data.toString('base64') %>" alt="Profile Picture" id="profileImg">
            <% } else { %>
                <img src="/images/DefaultProfilePic.jpg" alt="Profile Picture" id="profileImg" style="width: 100px; height: 100px; border-radius: 50%;">
            <% } %>
            <span id="editLabel" class="edit-label">Edit</span>
            <form id="uploadForm" action="/api/profilepictureupload" method="POST" enctype="multipart/form-data" style="display: none;">
                <input type="hidden" name="userId" value="<%= user._id %>">
                <input type="file" name="profilePicture" id="profilePictureInput" style="display: none;" accept="image/*" required>
            </form>
        </div>
        
        <form id="editProfileForm" action="/api/editprofile" method="POST">
            <div class="user-info">
                <button type="button" id="editButton" class="edit-btn">Edit</button>
                <h2 id="userName"><%= user.firstName %> <%= user.lastName %></h2>
                <label for="userEmail">Email:</label>
                <input type="email" name="email" id="userEmail" value="<%= user.email %>" disabled>
                <label for="userPhone">Phone Number:</label>
                <input type="tel" name="phoneNumber" id="userPhone" value="<%= user.phoneNumber %>" disabled>
                <label for="userAddress">Address:</label>
                <input type="text" name="address" id="userAddress" value="<%= user.address %>" disabled>
                <label for="school">Current School:</label>
                <input type="text" name="school" id="school" value="<%= user.school %>" disabled>
                <label for="grade">Grade Level:</label>
                <input type="text" name="grade" id="grade" value="<%= user.grade %>" disabled>
                <label for="subjects">Subjects Needing Help In:</label>
                <input type="text" name="subjects" id="subjects" value="<%= user.subjects %>" disabled>
                <label for="learningStyle">Preferred Learning Style:</label>
                <select name="learningStyle" id="learningStyle" disabled>
                    <option value="visual" <%= user.learningStyle === 'visual' ? 'selected' : '' %>>Visual</option>
                    <option value="auditory" <%= user.learningStyle === 'auditory' ? 'selected' : '' %>>Auditory</option>
                    <option value="reading/writing" <%= user.learningStyle === 'reading/writing' ? 'selected' : '' %>>Reading/Writing</option>
                    <option value="kinesthetic" <%= user.learningStyle === 'kinesthetic' ? 'selected' : '' %>>Kinesthetic</option>
                </select>
                <label for="goals">Academic Goals:</label>
                <textarea name="goals" id="goals" rows="4" disabled><%= user.goals %></textarea>
                <label for="learningChallenges">Learning Challenges/Accommodations:</label>
                <textarea name="learningChallenges" id="learningChallenges" rows="4" disabled><%= user.learningChallenges %></textarea>
                <button type="submit" id="saveButton" class="save-btn" disabled>Save Changes</button>
            </div>
        </form>
    </div>

    <%- include("../partials/footer.ejs") %>
    <script>
        let originalProfilePictureSrc = document.getElementById('profileImg').src;
        let originalValues = {};

        document.querySelectorAll('#editProfileForm input, #editProfileForm textarea, #editProfileForm select').forEach(input => {
            originalValues[input.name] = input.value;
        });

        document.getElementById('profilePictureInput').addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImg').src = e.target.result;
                }
                reader.readAsDataURL(this.files[0]);
                document.getElementById('uploadForm').submit();
            }
        });

        document.getElementById('editLabel').addEventListener('click', function() {
            document.getElementById('profilePictureInput').click();
        });

        const profilePictureContainer = document.querySelector('.profile-picture');
        const profilePicture = document.getElementById('profileImg');
        const editLabel = document.createElement('div');
        editLabel.id = 'editLabel';
        editLabel.innerText = 'Edit';
        editLabel.style.position = 'absolute';
        editLabel.style.top = '50%';
        editLabel.style.left = '50%';
        editLabel.style.transform = 'translate(-50%, -50%)';
        editLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
        editLabel.style.padding = '5px';
        editLabel.style.borderRadius = '5px';
        editLabel.style.display = 'none';
        editLabel.style.cursor = 'pointer';
        profilePictureContainer.appendChild(editLabel);

        profilePictureContainer.addEventListener('mouseenter', function() {
            editLabel.style.display = 'block';
        });
        profilePictureContainer.addEventListener('mouseleave', function() {
            editLabel.style.display = 'none';
        });

        editLabel.addEventListener('click', function() {
            document.getElementById('profilePictureInput').click();
        });

        document.getElementById('editButton').addEventListener('click', function() {
            const inputs = document.querySelectorAll('#editProfileForm input:not([id="userName"]), #editProfileForm select, #editProfileForm textarea');
            const saveButton = document.getElementById('saveButton');
            inputs.forEach(input => {
                input.disabled = !input.disabled;
            });
            saveButton.disabled = !saveButton.disabled;
            this.textContent = inputs[0].disabled ? 'Edit' : 'Cancel Edit';
            if (inputs[0].disabled) {
                inputs.forEach(input => {
                    input.value = originalValues[input.name];
                });
            } else {
                inputs.forEach(input => {
                    originalValues[input.name] = input.value;
                });
            }
        });
    </script>
</body>
</html>
