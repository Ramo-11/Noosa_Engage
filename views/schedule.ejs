<!DOCTYPE html>
<html>
<head>
    <title>Schedule an Appointment</title>
    <link rel="stylesheet" href="/styles/general.css">
    <link rel="stylesheet" href="/styles/schedule.css">
    <link rel="shortcut icon" href="/images/Logo-white.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <%- include("./partials/nav.ejs") %>
    <div class="main-content">
        <div class="title-div">
            <h1>Schedule an Appointment</h1>
        </div>
        <div class="schedule-form">
            <h1>Appointment Details</h1>
            <p class="submitFlag" id="submitFlag" hidden></p>
            <div class="submitter-name">
                <input type="text" id="name" class="input" placeholder="Full Name" maxlength="50">
            </div>
            <div class="submitter-email">
                <input type="email" id="email" class="input" placeholder="Email" maxlength="50">
            </div>
            <div class="submitter-tutor">
                <select id="tutor" class="input" onchange="onTutorChange()">
                    <option value="" disabled selected>Select Tutor</option>
                    <option value="Mostafa Abdulaleem">Mostafa Abdulaleem</option>
                    <option value="Omar Abdelalim">Omar Abdelalim</option>
                </select>
            </div>
            <div class="submitter-date-time">
                <div class="submitter-date" id="dateContainer" style="display: none;">
                    <input type="text" id="date" class="input" placeholder="Date">
                    <span class="calendar-icon">&#128197;</span>
                </div>
                <div class="submitter-time" id="timeContainer" style="display: none;">
                    <select id="time" class="input">
                        <option value="" disabled selected>Select Time</option>
                    </select>
                </div>
            </div>
            <button class="submitButton" id="submitButton" onclick="submitAppointment()">Submit</button>
        </div>
    </div>
    <%- include("./partials/footer.ejs") %>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let datePicker;

        document.addEventListener('DOMContentLoaded', function() {
            datePicker = flatpickr("#date", {
                enableTime: false,
                dateFormat: "Y-m-d",
                disable: [],
                onChange: function(selectedDates, dateStr) {
                    updateTimes(dateStr);
                    validateDate(dateStr);
                }
            });
        });

        async function onTutorChange() {
            const tutor = document.getElementById("tutor").value;

            const dateContainer = document.getElementById("dateContainer");
            const timeContainer = document.getElementById("timeContainer");
            dateContainer.style.display = tutor ? 'block' : 'none';

            document.getElementById("date").value = '';
            document.getElementById("time").innerHTML = '<option value="" disabled selected>Select Time</option>';
            timeContainer.style.display = 'none';

            document.getElementById("submitFlag").hidden = true;

            if (tutor) {
                try {
                    const response = await fetch(`/api/getAvailableDatesForTutor?tutor=${encodeURIComponent(tutor)}`);
                    const availableDates = await response.json();
                    updateDatePicker(availableDates);
                } catch (error) {
                    console.error("Error fetching available dates:", error);
                }
            }
        }

        function updateDatePicker(availableDates) {
            const formattedDates = availableDates.map(date => date.toString());

            if (datePicker) {
                datePicker.set('disable', [
                    function(date) {
                        const dateStr = date.toISOString().split('T')[0];
                        return !formattedDates.includes(dateStr);
                    }
                ]);
                datePicker.redraw();
            }
        }

        async function updateTimes(date) {
            const timeSelect = document.getElementById("time");
            timeSelect.innerHTML = '<option value="" disabled selected>Select Time</option>'; // Clear previous options

            const timeContainer = document.getElementById("timeContainer");
            const tutor = document.getElementById("tutor").value;
            const submitFlag = document.getElementById("submitFlag");

            if (tutor && date) {
                try {
                    const response = await fetch(`/api/getAvailableTimesForTutorAndDate?tutor=${encodeURIComponent(tutor)}&date=${encodeURIComponent(date)}`);
                    const times = await response.json();

                    if (times.length === 0) {
                        timeContainer.style.display = 'none';
                    } else {
                        submitFlag.style.display = "none";
                        times.forEach(time => {
                            const option = document.createElement("option");
                            option.value = time;
                            option.textContent = time;
                            timeSelect.appendChild(option);
                        });
                        timeContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error fetching times:", error);
                    submitFlag.textContent = `Error fetching available times. Please try again.`;
                    submitFlag.style.display = "block";
                }
            } else {
                timeContainer.style.display = 'none';
                submitFlag.style.display = "none";
            }
        }


        async function validateDate(date) {
            const tutor = document.getElementById("tutor").value;
            const submitFlag = document.getElementById("submitFlag");
            submitFlag.hidden = true; // Hide error message initially

            if (tutor && date) {
                try {
                    // Fetch available times for the selected date
                    const response = await fetch(`/api/getAvailableTimesForTutorAndDate?tutor=${encodeURIComponent(tutor)}&date=${encodeURIComponent(date)}`);
                    const times = await response.json();
                } catch (error) {
                    console.error("Error validating date:", error);
                    submitFlag.textContent = "An error occurred while validating the date.";
                    submitFlag.hidden = false;
                }
            }
        }

        async function submitAppointment() {
            const fullName = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const date = document.getElementById("date").value;
            const time = document.getElementById("time").value;
            const tutor = document.getElementById("tutor").value;

            console.log('Submitting Appointment:', { fullName, email, date, time, tutor});

            const result = await fetch("/api/scheduleAppointment", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fullName,
                    email,
                    date,
                    time,
                    tutor
                })
            });

            const message = await result.json();
            const submitFlag = document.getElementById("submitFlag");
            submitFlag.innerHTML = message["message"];
            submitFlag.style.display = "block";

            if (result.status === 200) {
                submitFlag.style.color = "#0a3755";
                submitFlag.style.backgroundColor = "#b7dffa";
                await sleep(1000);
                window.location.href = "/";
            } else {
                submitFlag.style.color = "#D8000C";
                submitFlag.style.backgroundColor = "#FFBABA";
                await sleep(2000);
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
    </script>
</body>
</html>
